<!DOCTYPE html>
<html>
<head>
  <title>Morse Waterfall</title>
  <style>
    body { background: black; margin: 0; overflow: hidden; }
    canvas { display: block; margin: auto; }
  </style>
</head>
<body>
<canvas id="waterfall" width="600" height="300"></canvas>

<script>
  const canvas = document.getElementById('waterfall');
  const ctx = canvas.getContext('2d');
  const waterfall = [];
  const socket = new WebSocket(`wss://${location.host}/api/ws`);

  const audioCtx = new (window.AudioContext || window.webkitAudioContext)();

  function drawWaterfall() {
    ctx.drawImage(canvas, 0, 1); // сдвигаем вверх
    ctx.fillStyle = 'black';
    ctx.fillRect(0, canvas.height - 1, canvas.width, 1);

    const last = waterfall[waterfall.length - 1];
    if (last) {
      const x = (Date.now() / 50) % canvas.width;
      ctx.fillStyle = last.type === 'dot' ? 'lime' : 'red';
      ctx.fillRect(x, canvas.height - 1, 2, 1);
    }

    requestAnimationFrame(drawWaterfall);
  }

  function playTone(freq, duration) {
    const osc = audioCtx.createOscillator();
    const gain = audioCtx.createGain();
    osc.frequency.value = freq;
    osc.type = 'sine';
    osc.connect(gain);
    gain.connect(audioCtx.destination);
    gain.gain.value = 0.3;
    osc.start();
    osc.stop(audioCtx.currentTime + duration);
  }

  socket.onmessage = (event) => {
    const data = JSON.parse(event.data);
    waterfall.push(data);
    const duration = data.type === 'dot' ? 0.1 : 0.3;
    playTone(data.frequency || 600, duration);
  };
  
  setInterval(() => {
  const type = Math.random() > 0.5 ? 'dot' : 'dash';
  const freq = 600 + Math.random() * 100;
  socket.dispatchEvent(new MessageEvent('message', {
    data: JSON.stringify({ type, frequency: freq })
  }));
}, 300);


  drawWaterfall();
</script>
</body>
</html>
